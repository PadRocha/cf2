"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,a=arguments.length,s=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;0<=o;o--)(i=e[o])&&(s=(a<3?i(s):3<a?i(t,r,s):i(t,r))||s);return 3<a&&s&&Object.defineProperty(t,r,s),s},__awaiter=this&&this.__awaiter||function(e,s,o,u){return new(o=o||Promise)(function(r,t){function n(e){try{a(u.next(e))}catch(e){t(e)}}function i(e){try{a(u.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?r(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(n,i)}a((u=u.apply(e,s||[])).next())})},__generator=this&&this.__generator||function(r,n){var i,a,s,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,a&&(s=2&t[0]?a.return:t[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,a=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(s=0<(s=o.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){o.label=t[1];break}if(6===t[0]&&o.label<s[1]){o.label=s[1],s=t;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(t);break}s[2]&&o.ops.pop(),o.trys.pop();continue}t=n.call(r,o)}catch(e){t=[6,e],a=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};exports.__esModule=!0,exports.KeysService=void 0;var core_1=require("@angular/core"),environment_1=require("@environments/environment"),components_1=require("@home/components"),functions_1=require("@shared/functions"),rxjs_1=require("rxjs"),KeysService=function(){function e(e){this.http=e,this.viewChange$=new rxjs_1.Subject,this.resetSatus=new rxjs_1.Subject,this.url=environment_1.environment.httpUrl,this.info={status:{defective:0,found:0,photographed:0,prepared:0,edited:0,saved:0},success:0},this.keys_array=new Array,this.metadata={totalDocs:0,limit:0,page:1,nextPage:null,prevPage:null,hasNextPage:!1,hasPrevPage:!1,totalPages:0},this.page=0,this.loading=!1,this.params={},this.getView()}return e.prototype.getView=function(){var t=this;this.viewChange$.subscribe(function(e){t.view=e})},Object.defineProperty(e.prototype,"container",{set:function(e){this.viewChange$.next(e)},enumerable:!1,configurable:!0}),e.prototype.getKeys=function(e){return this.http.get(this.url+"/key",{params:e,withCredentials:!1})},e.prototype.getKeysInfo=function(e){return this.http.get(this.url+"/key/info",{params:e,withCredentials:!1})},e.prototype.getNextLast=function(e){return this.http.get(this.url+"/key/"+e+"/next")},e.prototype.reset=function(){this.keys_array=new Array,this.page=0},e.prototype.more=function(){var n=this;++this.page,this.loading=!0,this.getKeys(__assign({page:this.page},this.params)).subscribe({next:function(e){var t=e.data,r=e.metadata;n.keys_array=n.keys_array.concat(t),n.metadata=r,n.loading=!1},error:function(e){n.loading=!1}})},e.prototype.showImages=function(e,t){this.view&&(this.view.clear(),this.modalImage=this.view.createComponent(components_1.ModalImageComponent),this.modalImage.instance.key=e,this.modalImage.changeDetectorRef.detectChanges(),this.modalImage.instance.show(t))},e.prototype.edit=function(e){this.view&&(this.view.clear(),this.modalKey=this.view.createComponent(components_1.ModalKeyComponent),this.modalKey.instance.key=e,this.modalKey.changeDetectorRef.detectChanges(),this.modalKey.instance.show())},e.prototype.editImage=function(e,t){this.view&&(this.view.clear(),this.modalEditor=this.view.createComponent(components_1.ModalEditorComponent),this.modalEditor.instance.key=e,this.modalEditor.instance.image=t,this.modalEditor.changeDetectorRef.detectChanges(),this.modalEditor.instance.show())},Object.defineProperty(e.prototype,"refresh",{set:function(e){var r=this;this.params=e,this.reset(),this.more(),this.getKeysInfo(e).subscribe(function(e){var t=e.data;return r.info=t})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"get",{get:function(){return this.keys_array.sort(function(e,t){return e.code>t.code?1:t.code>e.code?-1:0})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasNextPage",{get:function(){return this.metadata.hasNextPage},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"percentage",{get:function(){return 0===this.info.success?0:100*this.info.success/this.metadata.totalDocs},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"total",{get:function(){return this.metadata.totalDocs},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isEmpty",{get:function(){return 0===this.keys_array.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"prev",{set:function(t){var e,r;if(1<this.keys_array.length){var n=this.keys_array.findIndex(function(e){return e.code===t});if(0!==n){for(;--n,(null===(r=null===(e=this.keys_array[n])||void 0===e?void 0:e.image)||void 0===r||!r.some(function(e){return 5===e.status}))&&0!==n;);this.modalImage&&(this.modalImage.instance.key=this.keys_array[n])}else functions_1.Alert.fire({title:"No hay imagen anterior",text:"Es la primera",icon:"error"})}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"next",{set:function(t){var e,r;if(1<this.keys_array.length){var n=this.keys_array.findIndex(function(e){return e.code===t});if(n!==this.keys_array.length-1){for(;++n,(null===(r=null===(e=this.keys_array[n])||void 0===e?void 0:e.image)||void 0===r||!r.some(function(e){return 5===e.status}))&&n<this.keys_array.length;);this.modalImage&&(this.modalImage.instance.key=this.keys_array[n])}else functions_1.Alert.fire({title:"No hay imagen siguiente",text:"Consulta mÃ¡s",icon:"error"})}},enumerable:!1,configurable:!0}),e.prototype.delete=function(s){return __awaiter(this,void 0,void 0,function(){var t,r,n,i,a=this;return __generator(this,function(e){switch(e.label){case 0:return t=this.keys_array[this.keys_array.length-1].code,[4,this.getNextLast(t).toPromise().catch(function(){return null})];case 1:return null!=(r=e.sent())&&r.data&&this.keys_array.push(r.data),n=this.keys_array.findIndex(function(e){return e._id===s}),i=!1,this.keys_array[n].image.forEach(function(e){var t=e.status;5!==t||i||(a.substractSuccess(),i=!0),a.substractStatus=t}),--this.metadata.totalDocs,this.keys_array.splice(n,1),[2]}})})},e.prototype.deleteImage=function(t,r){var e=this.keys_array.findIndex(function(e){return e._id===t}),n=this.keys_array[e].image.findIndex(function(e){return e.idN===r.idN});1===this.keys_array[e].image.filter(function(e){return 5===e.status}).length&&this.substractSuccess(),this.keys_array[e].image.splice(n,1),this.substractStatus=r.status,this.resetSatus.next(e)},Object.defineProperty(e.prototype,"update",{set:function(t){var e,r,n=this.keys_array.findIndex(function(e){return e._id===t._id});this.keys_array[n].code=(null===(e=t.line)||void 0===e?void 0:e.identifier)+(null===(r=t.line)||void 0===r?void 0:r.supplier.identifier)+t.code,this.keys_array[n].desc=t.desc},enumerable:!1,configurable:!0}),e.prototype.updateImage=function(t,r){var e=this.keys_array.findIndex(function(e){return e._id===t}),n=this.keys_array[e].image.findIndex(function(e){return e.idN===r.idN});this.keys_array[e].image[n]=r},e.prototype.resetImage=function(t,e){var r=this,n=this.keys_array.findIndex(function(e){return e._id===t}),i=!1;this.keys_array[n].image.forEach(function(e){var t=e.status;5!==t||i||(r.substractSuccess(),i=!0),r.substractStatus=t});for(var a=new Array,s=0;s<3;s++)a.push({idN:s,status:e,public_id:null,url:null});this.keys_array[n].image=a,this.resetSatus.next(n)},e.prototype.addSuccess=function(){++this.info.success},e.prototype.substractSuccess=function(){--this.info.success},e.prototype.status=function(e){var t=this.statusName(e);return t?this.info.status[t]:0},e.prototype.statusName=function(e){switch(e){case 0:return"defective";case 1:return"found";case 2:return"photographed";case 3:return"prepared";case 4:return"edited";case 5:return"saved";default:return null}},Object.defineProperty(e.prototype,"addStatus",{set:function(e){var t=this.statusName(e);t&&++this.info.status[t]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"substractStatus",{set:function(e){var t=this.statusName(e);t&&--this.info.status[t]},enumerable:!1,configurable:!0}),e.prototype.replace=function(e,t){e&&(this.substractStatus=+e),t&&(this.addStatus=+t)},e=__decorate([core_1.Injectable({providedIn:"root"})],e)}();exports.KeysService=KeysService;