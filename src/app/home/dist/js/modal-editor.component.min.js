"use strict";var __decorate=this&&this.__decorate||function(e,t,o,i){var n,r=arguments.length,a=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,i);else for(var s=e.length-1;0<=s;s--)(n=e[s])&&(a=(r<3?n(a):3<r?n(t,o,a):n(t,o))||a);return 3<r&&a&&Object.defineProperty(t,o,a),a},__param=this&&this.__param||function(o,i){return function(e,t){i(e,t,o)}};exports.__esModule=!0,exports.ModalEditorComponent=void 0;var common_1=require("@angular/common"),core_1=require("@angular/core"),forms_1=require("@angular/forms"),bootstrap_1=require("bootstrap"),fabric_1=require("fabric"),sweetalert2_1=require("sweetalert2"),ModalEditorComponent=function(){function e(e,t,o){this.element=e,this.keys=t,this.platformId=o,this.key={_id:"",code:"",desc:"",image:new Array,createdAt:new Date,updatedAt:new Date},this.image={idN:0,status:0,url:null,public_id:null},this.canvas_width=708,this.canvas_heigth=500,this.form_IText=new forms_1.FormGroup({fill:new forms_1.FormControl("",[forms_1.Validators.required]),fontFamily:new forms_1.FormControl("",[forms_1.Validators.required]),textAlign:new forms_1.FormControl("",[forms_1.Validators.required]),backgroundColor:new forms_1.FormControl("",[forms_1.Validators.required]),textBackgroundColor:new forms_1.FormControl("",[forms_1.Validators.required]),stroke:new forms_1.FormControl("",[forms_1.Validators.required]),strokeWidth:new forms_1.FormControl(1,[forms_1.Validators.required]),fontSize:new forms_1.FormControl(1,[forms_1.Validators.required]),lineHeight:new forms_1.FormControl(0,[forms_1.Validators.required]),fontWeight:new forms_1.FormControl("",[forms_1.Validators.required]),fontStyle:new forms_1.FormControl("",[forms_1.Validators.required]),textDecoration:new forms_1.FormControl("",[forms_1.Validators.required])}),this.key_down=!1}return e.prototype.ngOnInit=function(){var n=this;this.form_IText.valueChanges.subscribe(function(e){var t,o,i=null===(t=n.canvas)||void 0===t?void 0:t.getActiveObject();i&&(i.set({fill:e.fill,fontFamily:e.fontFamily,textAlign:e.textAlign,backgroundColor:e.backgroundColor,textBackgroundColor:e.textBackgroundColor,stroke:e.stroke,strokeWidth:e.strokeWidth,fontSize:e.fontSize,lineHeight:e.lineHeight}),null!==(o=n.canvas)&&void 0!==o&&o.requestRenderAll())})},e.prototype.ngAfterViewInit=function(){var t=this;this.modal=new bootstrap_1.Modal(this.element.nativeElement),this.canvas=new fabric_1.fabric.Canvas(this.canvaselement.nativeElement),this.canvas.requestRenderAll(),this.canvas.on("mouse:down",function(e){return t.mouseDown(e)}),this.canvas.on("mouse:move",function(e){return t.mouseMove(e)}),this.canvas.on("mouse:up",function(){return t.mouseUp()}),this.canvas.on("selection:updated",function(){return t.canvasSelection()}),this.canvas.on("selection:created",function(){return t.canvasSelection()})},e.prototype.ngAfterViewChecked=function(){},e.prototype.ngOnDestroy=function(){this.hide()},e.prototype.resize=function(){var e;common_1.isPlatformBrowser(this.platformId)&&(575<(e=window.innerWidth)&&e<=992?(this.canvas_width=466,this.canvas_heigth=329.0960452):e<575?(this.canvas_heigth=(e-50)*this.canvas_heigth/this.canvas_width,this.canvas_width=e-50):(this.canvas_width=708,this.canvas_heigth=500),this.renderImage())},e.prototype.reset=function(){this.keys.showImages(this.key,this.image.idN)},e.prototype.show=function(){var e,t;null!==(e=this.canvas)&&void 0!==e&&e.clear(),null!==(t=this.modal)&&void 0!==t&&t.show(),this.resize(),this.renderImage()},e.prototype.hide=function(){var e;null!==(e=this.modal)&&void 0!==e&&e.hide()},e.prototype.mouseDown=function(e){var t,o,i=e.e;this.key_down=!0;var n=null===(t=this.canvas)||void 0===t?void 0:t.getPointer(i),r=[null==n?void 0:n.x,null==n?void 0:n.y,null==n?void 0:n.x,null==n?void 0:n.y];this.draw_checkbox.nativeElement.checked&&(this.canvas_line=new fabric_1.fabric.Line(r,{strokeWidth:5,fill:"#000000",stroke:"#000000",originX:"center",originY:"center"}),null!==(o=this.canvas)&&void 0!==o&&o.add(this.canvas_line))},e.prototype.mouseMove=function(e){var t,o,i,n,r=e.e;this.key_down&&(n=null===(t=this.canvas)||void 0===t?void 0:t.getPointer(r),this.draw_checkbox.nativeElement.checked&&(null!==(o=this.canvas_line)&&void 0!==o&&o.set({x2:null==n?void 0:n.x,y2:null==n?void 0:n.y}),null!==(i=this.canvas)&&void 0!==i&&i.requestRenderAll()))},e.prototype.mouseUp=function(){this.key_down=!1,this.draw_checkbox.nativeElement.checked=!1},e.prototype.canvasSelection=function(){var e,t,o,i,n,r,a,s,l,c,d,v,u,h,m;"text"===(null===(t=null===(e=this.canvas)||void 0===e?void 0:e.getActiveObject())||void 0===t?void 0:t.get("type"))?(m=null===(o=this.canvas)||void 0===o?void 0:o.getActiveObject(),null!==(i=this.form_IText.get("fill"))&&void 0!==i&&i.setValue(m.fill,{emitEvent:!1}),null!==(n=this.form_IText.get("fontFamily"))&&void 0!==n&&n.setValue(m.fontFamily,{emitEvent:!1}),null!==(r=this.form_IText.get("textAlign"))&&void 0!==r&&r.setValue(m.textAlign,{emitEvent:!1}),null!==(a=this.form_IText.get("backgroundColor"))&&void 0!==a&&a.setValue(m.backgroundColor,{emitEvent:!1}),null!==(s=this.form_IText.get("textBackgroundColor"))&&void 0!==s&&s.setValue(m.textBackgroundColor,{emitEvent:!1}),null!==(l=this.form_IText.get("stroke"))&&void 0!==l&&l.setValue(m.stroke,{emitEvent:!1}),null!==(c=this.form_IText.get("strokeWidth"))&&void 0!==c&&c.setValue(m.strokeWidth,{emitEvent:!1}),null!==(d=this.form_IText.get("fontSize"))&&void 0!==d&&d.setValue(m.fontSize,{emitEvent:!1}),null!==(v=this.form_IText.get("lineHeight"))&&void 0!==v&&v.setValue(m.lineHeight,{emitEvent:!1})):null===(h=null===(u=this.canvas)||void 0===u?void 0:u.getActiveObject())||void 0===h||h.get("type")},e.prototype.renderImage=function(){var e,t,o=this;null!==(e=this.canvas)&&void 0!==e&&e.setWidth(this.canvas_width),null!==(t=this.canvas)&&void 0!==t&&t.setHeight(this.canvas_heigth),this.image.url&&fabric_1.fabric.Image.fromURL(this.image.url,function(e){var t;e.scaleToWidth(o.canvas_width),e.scaleToHeight(o.canvas_heigth),null!==(t=o.canvas)&&void 0!==t&&t.setBackgroundImage(e,o.canvas.requestRenderAll.bind(o.canvas))})},e.prototype.addText=function(){var n=this;sweetalert2_1.default.fire({title:"Escriba algo",input:"textarea",inputPlaceholder:"Inserte el texto...",keydownListenerCapture:!0}).then(function(e){var t,o=e.isConfirmed,i=e.value;o&&null!==(t=n.canvas)&&void 0!==t&&t.add(new fabric_1.fabric.Text(i))})},e.prototype.deleteObject=function(){var e,t,o,i,n,r,a=this;1===(null===(e=this.canvas)||void 0===e?void 0:e.getActiveObjects().length)?null!==(t=this.canvas)&&void 0!==t&&t.remove(null===(o=this.canvas)||void 0===o?void 0:o.getActiveObject()):1<(null===(i=this.canvas)||void 0===i?void 0:i.getActiveObjects().length)&&null!==(n=this.canvas)&&void 0!==n&&n.getActiveObjects().forEach(function(e){var t;null!==(t=a.canvas)&&void 0!==t&&t.remove(e)}),null!==(r=this.canvas)&&void 0!==r&&r.discardActiveObject()},Object.defineProperty(e.prototype,"lineSelected",{get:function(){var e,t;return"line"===(null===(t=null===(e=this.canvas)||void 0===e?void 0:e.getActiveObject())||void 0===t?void 0:t.get("type"))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"textSelected",{get:function(){var e,t;return"text"===(null===(t=null===(e=this.canvas)||void 0===e?void 0:e.getActiveObject())||void 0===t?void 0:t.get("type"))},enumerable:!1,configurable:!0}),__decorate([core_1.ViewChild("canvas")],e.prototype,"canvaselement"),__decorate([core_1.ViewChild("img")],e.prototype,"img"),__decorate([core_1.ViewChild("draw")],e.prototype,"draw_checkbox"),__decorate([core_1.HostListener("window:resize")],e.prototype,"resize"),__decorate([core_1.HostListener("hidden.bs.modal")],e.prototype,"reset"),e=__decorate([core_1.Component({selector:"modal-editor",templateUrl:"./modal-editor.component.html",styleUrls:["./modal-editor.component.scss"],host:{class:"modal fade animate__animated animate__backInDown"}}),__param(2,core_1.Inject(core_1.PLATFORM_ID))],e)}();exports.ModalEditorComponent=ModalEditorComponent;