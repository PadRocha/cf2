"use strict";var __decorate=this&&this.__decorate||function(e,t,r,n){var o,i=arguments.length,a=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;0<=s;s--)(o=e[s])&&(a=(i<3?o(a):3<i?o(t,r,a):o(t,r))||a);return 3<i&&a&&Object.defineProperty(t,r,a),a},__awaiter=this&&this.__awaiter||function(e,a,s,u){return new(s=s||Promise)(function(r,t){function n(e){try{i(u.next(e))}catch(e){t(e)}}function o(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?r(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(n,o)}i((u=u.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,i,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=n.call(r,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};exports.__esModule=!0,exports.KeyComponent=void 0;var core_1=require("@angular/core"),forms_1=require("@angular/forms"),functions_1=require("@shared/functions"),operators_1=require("rxjs/operators"),sweetalert2_1=require("sweetalert2"),KeyComponent=function(){function e(e,t,r,n){this.user=e,this.keys=t,this.exchanges=r,this.shippings=n,this.status_selects=new Array(new forms_1.FormControl(""),new forms_1.FormControl(""),new forms_1.FormControl(""))}return e.prototype.ngOnInit=function(){this.formsConfig()},e.prototype.formsConfig=function(){var r=this;this.updateStatus(),this.status_selects.forEach(function(s,u){var e,t=null===(e=r.key.image.find(function(e){return e.idN===u}))||void 0===e?void 0:e.status;s.valueChanges.pipe(operators_1.debounceTime(500),operators_1.startWith(null!=t?t:""),operators_1.pairwise()).subscribe(function(e){var i=e[0],a=e[1];return __awaiter(r,void 0,void 0,function(){var r,t,n,o=this;return __generator(this,function(e){switch(e.label){case 0:return"5"!==a?[3,2]:""===i?[2,s.setValue(i,{emitEvent:!1})]:"5"===i&&"5"===a?[2,s.setValue("",{emitEvent:!1})]:[4,sweetalert2_1.default.fire({title:"Select image",input:"file",inputAttributes:{accept:"image/*","aria-label":"Upload your profile picture"}}).then(function(e){return(e.isDismissed||e.isDenied)&&s.setValue(i),e})];case 1:return(r=e.sent().value)?((t=new FileReader).onload=function(e){var t=e.target;sweetalert2_1.default.fire({title:"¿Seguro de querer subir imagen?",imageUrl:null==t?void 0:t.result,imageAlt:"Imagen pendiente",showConfirmButton:!0,confirmButtonText:"Subir",focusConfirm:!0,showLoaderOnConfirm:!0,preConfirm:function(){var e=new FormData;return e.append("image",r,r.name),o.shippings.sendImage(o.key._id,u,e).toPromise().catch(function(){s.setValue(i),s.enable({emitEvent:!1}),functions_1.Alert.fire({title:"Error Imagen",text:o.key.code+" ~ ["+(u+1)+"] image",icon:"error"})})}}).then(function(e){var t=e.isConfirmed,r=e.value;t&&r?(o.keys.replace(i,a),0===o.key.image.filter(function(e){return 5===e.status}).length&&o.keys.addSuccess(),o.key.image=r.data.image,s.disable({emitEvent:!1}),functions_1.Alert.fire({title:"Imagen Actualizada",text:o.key.code+" ~ ["+(u+1)+"] image",icon:"success"})):s.setValue(i)})},t.readAsDataURL(r)):s.setValue(i),[3,3];case 2:"5"!==i&&"5"!==a&&(n=a?{status:+a}:{},s.disable({emitEvent:!1}),this.exchanges.updateStatus(this.key._id,u,n).subscribe({next:function(e){var t=e.data;o.key.image=t.image,o.keys.replace(i,a),s.enable({emitEvent:!1}),functions_1.Alert.fire({title:"Actualizado",text:o.key.code+" ~ ["+(u+1)+"] status",icon:"success"})},error:function(){s.setValue(i),s.enable({emitEvent:!1}),functions_1.Alert.fire({title:"Error Actualización",text:o.key.code+" ~ ["+(u+1)+"] status",icon:"error"})}})),e.label=3;case 3:return[2]}})})})})},e.prototype.updateStatus=function(){var i=this;this.status_selects.forEach(function(e,t){var r,n,o=null===(r=i.key.image.find(function(e){return e.idN===t}))||void 0===r?void 0:r.status;e.setValue(null!==(n=null==o?void 0:o.toString())&&void 0!==n?n:"",{emitEvent:!1}),5===o?e.disable({emitEvent:!1}):e.enable({emitEvent:!1})})},Object.defineProperty(e.prototype,"formsStatus",{get:function(){return this.key.image.length<1?new Array(this.status_selects[0]):this.status_selects},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"images",{get:function(){return this.key.image.sort(function(e,t){return e.idN-t.idN}).filter(function(e){return e.url})},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasRole",{get:function(){return this.user.hasRole(["EDIT","GRANT","ADMIN"])},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasImage",{get:function(){return!(this.images.length<1)&&null},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasDefective",{get:function(){return this.key.image.some(function(e){return 0===e.status})},enumerable:!1,configurable:!0}),e.prototype.viewImages=function(){this.keys.showImages(this.key)},e.prototype.statusClass=function(e){return e.value?"idN"+e.value:""},e.prototype.configKey=function(){var n=this;sweetalert2_1.default.fire({title:this.key.code,showDenyButton:!0,showConfirmButton:this.user.hasRole(["GRANT","ADMIN"]),denyButtonText:"Editar Clave",confirmButtonText:"Eliminar Clave",denyButtonAriaLabel:"Editar clave "+this.key.code,confirmButtonAriaLabel:"Eliminar clave "+this.key.code,denyButtonColor:"rgb(62, 15, 116)",confirmButtonColor:"rgb(105, 8, 8)",keydownListenerCapture:!0}).then(function(e){var t=e.isConfirmed,r=e.isDenied;t?sweetalert2_1.default.fire({title:"¿Estás absolutamente seguro?",input:"text",html:"Por favor escriba <b>"+n.key.code+"</b> para confirmar.",inputAutoTrim:!0,inputValidator:function(e){return e!==n.key.code?"Confirma correctamente":null},showConfirmButton:!0,confirmButtonText:"Entiendo las consecuencias, eliminar x",confirmButtonAriaLabel:"Eliminar clave "+n.key.code,confirmButtonColor:"rgb(105, 8, 8)",showLoaderOnConfirm:!0,preConfirm:function(){return n.exchanges.deleteKey(n.key._id).toPromise().catch(function(){functions_1.Alert.fire({title:"Error Clave",text:n.key.code,icon:"error"})})}}).then(function(e){e.isConfirmed&&n.keys.delete(n.key._id)}):r&&n.keys.edit(n.key)})},__decorate([core_1.Input()],e.prototype,"key"),e=__decorate([core_1.Component({selector:"key",templateUrl:"./key.component.html",styleUrls:["./key.component.scss"],host:{class:"d-flex flex-column flex-lg-row border-bottom border-dark"}})],e)}();exports.KeyComponent=KeyComponent;